<style>

.wire {
  cursor: crosshair;
}

.component {
  position: relative;
  display: inline-block;
  font-weight: bold;
}

.dropdown {
  position: absolute;
  z-index: 1;
  background-color: black;
  color: white;
  padding: 10px;
}

.option {
  cursor: pointer;
}

.option:hover {
  color: green;
}

</style>
<script src='common.js'></script>
<script>

var gSystemInfo;
var gConnecting;

//===== system stuff =====//
async function diagram() {
  gSystemInfo = (await socketSend('system.info'))['result'];
  const diagram = (await socketSend('system.diagram'))['result'];
  e('diagram').innerHTML = diagram.split('\n').map(i => {
    return i.replace(/(.*\[)([^|]+)(\|*)(\].*)/, (match, left, name, space, right) => { 
      connectify = (s, side, name) => `<span class='wire' onclick="wire('${name}', '${side}')" id="${name}-${side}">` + s + '</span>';
      return [
        connectify(left, 'left', name),
        `<span id="component-${name}" class='component' oncontextmenu='context("${name}"); return false'>`,
        name,
        '</span>',
        space,
        connectify(right, 'right', name),
      ].join('');
    });
  }).join('<br>');
  e('main').style = '';
  e('socketConnect').style = 'display: none';
}

function context(componentName) {
  const dropdown = document.createElement('div');
  dropdown.className = 'dropdown';
  function addOption(name, f, arg) {
    const option = document.createElement('div');
    option.className = 'option';
    option.onclick = () => f(arg);
    option.innerText = name;
    dropdown.appendChild(option);
  }
  addOption('webboard', openPage, { url: 'webboard.html', componentName });
  const specifics = {
    'commander': { 'commander': 'commander.html' },
  }[gSystemInfo['component_types'][componentName]];
  for (const i in specifics) addOption(i, openPage, { url: specifics[i], componentName });
  e(`component-${componentName}`).appendChild(dropdown);
}

function contextDismiss() {
  const dropdowns = document.getElementsByClassName('dropdown');
  for (const i of dropdowns) i.parentElement.removeChild(i);
}

function openPage(args) {
  const url = args.url;
  const componentName = args.componentName;
  window.open(`${url}?host=${v('host')}&port=${v('port')}&component=${componentName}`, '_blank');
  contextDismiss();
}

async function component(name) {
  const r = await socketSend(`system.${name}`, { op: 'store' });
  return r.uuid;
}

async function invoke() {
  options = {};
  if (v('invokeArgs'  )) options.args = v('invokeArgs'  );
  if (v('invokeKwargs')) options.args = v('invokeKwargs');
  if (v('invokeOp'    )) options.args = v('invokeOp'    );
  if (v('invokeUuid'  )) options.args = v('invokeUuid'  );
  const response = await socketSend(v('invokePath'), options);
  e('invokeResponse').innerHTML = Object.keys(response).map((i) => {
    var v = response[i];
    if (i == 'path') v = v.join('.');
    return `${i}: ${v}`;
  }).join('<br>');
}

async function add() {
  var r = await socketSend('skeleton.component_builder', { args: [v('addType')], op: 'store' });
  var s = await socketSend(r.uuid, { op: 'store' });
  await socketSend('system.add', { args: [s.uuid] });
  diagram();
  socketFree(r.uuid);
  socketFree(s.uuid);
}

//----- connect -----//
async function connect(connector, connectee) {
  const a = await component(connector), b = await component(connectee);
  await socketSend(`${a}.connect`, { args: [b], kwargs: { toggle: true } });
  diagram();
  socketFree(a);
  socketFree(b);
}

function wire(name, side) {
  if (gConnecting) {
    connect(gConnecting.name, name);
    e(`${gConnecting.name}-${gConnecting.side}`).style = '';
    gConnecting = undefined;
  } else {
    e(`${name}-${side}`).style = 'color:blue';
    gConnecting = { name, side };
  }
}

//===== onload =====//
function enterFunction(id, f) {
  e(id).addEventListener('keyup', (event) => { if (event.keyCode == 13) f() });
}

window.onload = function() {
  e('host').value = 'localhost';
  e('port').value = 9121;
  enterFunction('addType', add);
  enterFunction('invokePath'  , invoke);
  enterFunction('invokeArgs'  , invoke);
  enterFunction('invokeKwargs', invoke);
  enterFunction('invokeOp'    , invoke);
  enterFunction('invokeUuid'  , invoke);
  window.onclick = (event) => {
    contextDismiss();
  };
  window.onkeyup = (event) => {
    if (event.keyCode == 27) {
      if (gConnecting) {
        e(`${gConnecting.name}-${gConnecting.side}`).style = '';
        gConnecting = undefined;
      }
      contextDismiss();
    }
  }
}

</script>
<body>

<div>
  <div id='socketConnect'>
    <div>
      <input type='text' id='host' placeholder='host'/>
    </div>
    <div>
      <input type='text' id='port' placeholder='port'/>
    </div>
    <div>
      <button onclick='socketConnect({ host: v("host"), port: v("port"), onOpen: diagram})'>connect</button>
    </div>
  </div>
  <div id='main' style='display: none'>
    <div id='diagram' style='font-family: Monospace; line-height: 1;'>
    </div>
    <div>
      <input type='text' id='addType' placeholder='type'/>
      <button onclick='add()'>add</button>
    </div>
    <div>
      <input type='text' id='invokePath' placeholder='path'/>
      <input type='text' id='invokeArgs' placeholder='args'/>
      <input type='text' id='invokeKwargs' placeholder='kwargs'/>
      <input type='text' id='invokeOp' placeholder='op'/>
      <input type='text' id='invokeUuid' placeholder='UUID'/>
      <button onclick='invoke()'>invoke</button>
      <div id='invokeResponse' style='font-family: Monospace'>
      </div>
    </div>
  </div>
</div>

</body>
