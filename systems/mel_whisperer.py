import dlal

import argparse

#===== args =====#
parser = argparse.ArgumentParser()
parser.add_argument('path', help='path to a mel spectrogram')
parser.add_argument('--duration', type=float, default=5.0)
args = parser.parse_args()

#===== system =====#
audio = dlal.Audio(driver=True)
comm = dlal.Comm(4096)
noisebank = dlal.Noisebank(mode='custom', bin_centers=[i/44100 for i in [
                        86.00788105,  122.0157621 ,  158.02364316,
        194.03152421,  230.03940526,  266.04728631,  302.05516736,
        338.06304842,  374.07092947,  410.07881052,  446.08669157,
        482.09457262,  518.10245368,  554.11033473,  590.11821578,
        626.12609683,  662.13397788,  698.14185894,  734.14973999,
        770.15762104,  806.16550209,  842.17338315,  878.1812642 ,
        914.18914525,  950.1970263 ,  986.20490735, 1023.17192274,
       1061.88073857, 1102.05399297, 1143.74708883, 1187.01752505,
       1231.92497584, 1278.53137302, 1326.90099142, 1377.10053753,
       1429.19924148, 1483.26895254, 1539.3842382 , 1597.62248698,
       1658.06401518, 1720.79217765, 1785.89348274, 1853.45771157,
       1923.57804191, 1996.35117663, 2071.87747707, 2150.26110147,
       2231.61014862, 2316.03680687, 2403.65750896, 2494.59309249,
       2588.96896663, 2686.91528504, 2788.56712539, 2894.06467561,
       3003.55342726, 3117.18437616, 3235.11423063, 3357.5056276 ,
       3484.5273569 , 3616.35459408, 3753.16914193, 3895.15968124,
       4042.52203101, 4195.4594185 , 4354.18275948, 4518.91094915,
       4689.87116397, 4867.29917499, 5051.43967298, 5242.5466059 ,
       5440.88352912, 5646.72396887, 5860.35179947, 6082.06163483,
       6312.15923475, 6550.96192657, 6798.79904283, 7056.01237541,
       7322.95664695,
]])
tape = dlal.Tape()

dlal.connect(
    noisebank,
    [audio, tape],
)

if args.path.endswith('.npy'):
    import numpy as np
    spec = np.load(args.path).transpose()
    spec -= spec.max()
    spec = np.power(10, spec)
    for i in spec:
        comm.queue(noisebank, 'spectrum', [i.tolist()], detach=True)
        comm.wait(512)
    comm.queue(noisebank, 'spectrum', [[0] * 80], detach=True)

#===== run =====#
dlal.typical_setup(duration=args.duration)
