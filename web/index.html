<style>

.wire {
  cursor: crosshair;
}

</style>
<script>

var gSocket;
var gPromiseResolvers = {};
var gComponentOrder;
var gConnecting;

function e(name){ return document.getElementById(name) }
function v(name){ return e(name).value }

// Math.random is probably good enough for this...
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.floor(Math.random() * 16), v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

//===== socket stuff =====//
function socketSend(path, options = {}){
  const uuid = options.uuid || uuidv4();
  gSocket.send(JSON.stringify({
    uuid,
    path: path.split('.'),
    args: options.args,
    kwargs: options.kwargs,
    op: options.op,
  }));
  return new Promise(function(resolve, reject){
    gPromiseResolvers[uuid] = { resolve, reject };
  });
}

function socketConnect(){
  gSocket = new WebSocket('ws://'+v('host')+':'+v('port'));
  gSocket.onopen = () => {
    diagram();
  };
  gSocket.onmessage = (event) => {
    response = JSON.parse(event.data);
    gPromiseResolvers[response.uuid].resolve(response);
  };
}

function free(uuid){
  return socketSend('free', { op: 'store', uuid });
}

//===== system stuff =====//
async function diagram(){
  gComponentOrder = {};
  e('diagram').innerHTML = (await socketSend('system.diagram'))['result'].split('\n').map(i => {
    return i.replace(/(.*\[)([^|]+)(\|*)(\].*)/, (match, left, name, space, right) => { 
      gComponentOrder[name] = Object.keys(gComponentOrder).length;
      connectify = (s, side, name) => `<span class='wire' onclick="wire('${name}', '${side}')" id="${name}-${side}">` + s + '</span>';
      return connectify(left, 'left', name) + name + space + connectify(right, 'right', name);
    });
  }).join('<br>');
  e('main').style = '';
  e('socketConnect').style = 'display: none';
}

async function component(name){
  const r = await socketSend(`system.${name}`, { op: 'store' });
  return r.uuid;
}

async function add(){
  var r = await socketSend('skeleton.component_builder', { args: [v('addType')], op: 'store' });
  var s = await socketSend(r.uuid, { op: 'store' });
  await socketSend('system.add', { args: [s.uuid] });
  diagram();
  free(r.uuid);
  free(s.uuid);
}

//----- connect -----//
async function connect(connector, connectee){
  const a = await component(connector), b = await component(connectee);
  await socketSend(`${a}.connect`, { args: [b], kwargs: { toggle: true } });
  diagram();
  free(a);
  free(b);
}

function wire(name, side){
  if (gConnecting) {
    connect(gConnecting.name, name);
    e(`${gConnecting.name}-${gConnecting.side}`).style = '';
    gConnecting = undefined;
  } else {
    e(`${name}-${side}`).style = 'color:blue';
    gConnecting = { name, side };
  }
}

//===== onload =====//
window.onload = function(){
  e('host').value = 'localhost';
  e('port').value = 9121;
  e('addType').addEventListener('keyup', (event) => { if (event.keyCode == 13) add() });
}

</script>
<body>

<div>
  <div id='socketConnect'>
    <div>
      <input type='text' id='host' placeholder='host'/>
    </div>
    <div>
      <input type='text' id='port' placeholder='port'/>
    </div>
    <div>
      <button onclick='socketConnect()'>connect</button>
    </div>
  </div>
  <div id='main' style='display: none'>
    <div id='diagram' style='font-family: Monospace'>
    </div>
    <div>
      <input type='text' id='addType' placeholder='type'/>
      <button onclick='add()'>add</button>
    </div>
  </div>
</div>

</body>
