<link rel='stylesheet' type='text/css' href='style.css'>
<style>

.wire {
  cursor: crosshair;
}

.wire:hover {
  color: green;
}

.component {
  position: relative;
  display: inline-block;
  font-weight: bold;
  background-image: linear-gradient(to top, #ccc, #fff);
}

.component:hover {
  color: green;
}

.component-audio {
  background-image: linear-gradient(to top, #cc0, #ff0);
}

.component-midi {
  background-image: linear-gradient(to top, #f88, #fff);
}

.component-liner {
  background-image: linear-gradient(to top, #8f8, #fff);
}

.component-sonic {
  background-image: linear-gradient(to top, #88f, #fff);
}

.component-buffer {
  background-image: linear-gradient(to top, #fc8, #fff);
}

.component-commander {
  background: white;
}

</style>
<script src='common.js'></script>
<script>

var gSystemInfo;
var gConnecting;

//===== system stuff =====//
async function diagram() {
  gSystemInfo = (await socketSend('system.info'))['result'];
  const diagram = (await socketSend('system.diagram'))['result'];
  e('diagram').innerHTML = diagram.split('\n').map(i => {
    return i.replace(/(.*\[)([^|]+)(\|*)(\].*)/, (match, left, name, space, right) => { 
      connectify = (s, side, name) => `<span class='wire' onclick="wire('${name}', '${side}')" id="${name}-${side}">` + s + '</span>';
      const type = gSystemInfo['component_types'][name];
      return [
        connectify(left, 'left', name),
        `<span id="component-${name}" class='component component-${type}' oncontextmenu='componentContext("${name}"); return false'>`,
        name,
        '</span>',
        space,
        connectify(right, 'right', name),
      ].join('');
    });
  }).join('<br>');
  e('main').style = '';
  e('socketConnect').style = 'display: none';
}

function componentContext(name) {
  const dropdown = context(e(`component-${name}`));
  contextOption(dropdown, 'webboard', openPage, { url: 'webboard.html', component: name });
  switch (gSystemInfo['component_types'][name]) {
    case 'audio':
      contextOption(dropdown, 'play', play, name);
      break;
    case 'commander':
      contextOption(dropdown, 'commander', openPage, { url: 'commander.html', component: name });
      break;
  }
}

function openPage(args) {
  window.open(`${args.url}?ws-url=${v('ws-url')}&component=${args.component}`, '_blank');
  contextDismiss();
}

async function invoke() {
  options = {};
  if (v('invokeArgs'  )) options.args = v('invokeArgs'  );
  if (v('invokeKwargs')) options.args = v('invokeKwargs');
  if (v('invokeOp'    )) options.args = v('invokeOp'    );
  if (v('invokeUuid'  )) options.args = v('invokeUuid'  );
  const response = await socketSend(v('invokePath'), options);
  e('invokeResponse').innerHTML = Object.keys(response).map((i) => {
    var v = response[i];
    if (i == 'path') v = v.join('.');
    return `${i}: ${v}`;
  }).join('<br>');
}

async function add() {
  var r = await socketSend('skeleton.component_builder', { args: [v('addType')], op: 'store' });
  var s = await socketSend(r.uuid, { op: 'store' });
  await socketSend('system.add', { args: [s.uuid] });
  diagram();
  free(r.uuid);
  free(s.uuid);
}

//----- connect -----//
async function connect(connector, connectee) {
  const a = await component(connector), b = await component(connectee);
  await socketSend(`${a}.connect`, { args: [b], kwargs: { toggle: true } });
  diagram();
  free(a);
  free(b);
}

function wire(name, side) {
  if (gConnecting) {
    connect(gConnecting.name, name);
    e(`${gConnecting.name}-${gConnecting.side}`).style = '';
    gConnecting = undefined;
  } else {
    e(`${name}-${side}`).style = 'color:blue';
    gConnecting = { name, side };
  }
}

//----- play -----//
function buffer_get(name, bufferSize, buffers) {
  return socketSend(
    `system.${name}.buffer_get`, { args: [bufferSize] }
  ).then((r) => {
    const buffer = []
    function convert(code) {
      if (code <= 57) return code - 46;// ./0123456789
      if (code <= 90) return code - 53;// A-Z
      return code - 59;// a-z
    }
    for (var i = 0; i < r.result.length; i += 2) {
      const lo = convert(r.result.charCodeAt(i));
      const hi = convert(r.result.charCodeAt(i + 1));
      buffer.push((lo + (hi << 6)) / (1 << 11) - 1);
    }
    buffers.push(buffer);
  });
}

async function play(name) {
  const bufferSize = 1 << 14;
  const buffersSize = 4;
  await socketSend(`system.${name}.buffer_resize`, { args: [17] });
  await sleep(2000);
  var buffers = [];
  for (var i = 0; i < buffersSize; ++i)
    await buffer_get(name, bufferSize, buffers);
  const context = new AudioContext({ sampleRate: 44100 });
  const processor = context.createScriptProcessor(bufferSize, 0, 1);
  processor.onaudioprocess = function(e) {
    if (buffers.length) {
      const audio = e.outputBuffer.getChannelData(0);
      for (var i = 0; i < bufferSize; i++)
        audio[i] = buffers[0][i];
      buffers.shift();
    }
    buffer_get(name, bufferSize, buffers);
  }
  processor.connect(context.destination);
}

//===== onload =====//
function enterFunction(id, f) {
  e(id).addEventListener('keyup', (event) => { if (event.keyCode == 13) f() });
}

window.onload = function() {
  e('ws-url').value = 'ws://localhost:9121';
  enterFunction('addType', add);
  enterFunction('invokePath'  , invoke);
  enterFunction('invokeArgs'  , invoke);
  enterFunction('invokeKwargs', invoke);
  enterFunction('invokeOp'    , invoke);
  enterFunction('invokeUuid'  , invoke);
  window.onclick = (event) => {
    contextDismiss();
  };
  window.onkeyup = (event) => {
    if (event.keyCode == 27) {
      if (gConnecting) {
        e(`${gConnecting.name}-${gConnecting.side}`).style = '';
        gConnecting = undefined;
      }
      contextDismiss();
    }
  }
}

</script>
<body>

<div>
  <div id='socketConnect'>
    <div>
      <input type='text' id='ws-url' placeholder='WebSocket URL' size=80/>
      <input type='button' value="dan's forwarder" onclick='e("ws-url").value = `wss://websocket-forwarder.herokuapp.com/ws/${uuidv4()}`'/>
    </div>
    <div>
      <button onclick='socketConnect({ url: v("ws-url"), onOpen: diagram})'>connect</button>
    </div>
  </div>
  <div id='main' style='display: none'>
    <div id='diagram' style='font-family: Monospace; line-height: 1;'>
    </div>
    <div>
      <input type='text' id='addType' placeholder='type'/>
      <button onclick='add()'>add</button>
    </div>
    <div>
      <input type='text' id='invokePath' placeholder='path'/>
      <input type='text' id='invokeArgs' placeholder='args'/>
      <input type='text' id='invokeKwargs' placeholder='kwargs'/>
      <input type='text' id='invokeOp' placeholder='op'/>
      <input type='text' id='invokeUuid' placeholder='UUID'/>
      <button onclick='invoke()'>invoke</button>
      <div id='invokeResponse' style='font-family: Monospace'>
      </div>
    </div>
  </div>
</div>

</body>
