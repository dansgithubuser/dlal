<head>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
  <script src='common.js'></script>
  <script>

var gWKey, gHKey;
var gKeys;
var gMessages = [];
var gDebug;

function debugLog(message) {
  if (!gDebug) return;
  gMessages.push(message);
  console.log(message);
}

function connect() {
  socketConnect();
  e('divInit').style.display = 'none';
  e('divBoard').style.display = '';
  resize();
  gDebug = e('debug').checked;
}

function send(note, down) {
  debugLog(`sending ${note}, ${down}`);
  socketSend(`system.${getUrlParam('component')}.midi`, {
    args: [`${down?0x90:0x80} ${note} 64`],
    kwargs: { detach: true },
  });
  debugLog(`sent ${note}, ${down}`);
}

function rect(context, xi, yi, xf, yf, r, g, b) {
  context.fillStyle = `rgb(${r}, ${g}, ${b})`;
  context.fillRect(xi, yi, xf - xi, yf - yi);
  context.stroke();
}

function resize() {
  var divBoard = e('divBoard');
  var canvas = e('canvas');
  canvas.width  = divBoard.offsetWidth;
  canvas.height = divBoard.offsetHeight;
  var context = canvas.getContext('2d');
  rect(context, 0, 0, canvas.width, canvas.height, 0, 0, 0);
  const hBoard=canvas.height / v('boards');
  const white = [1, 0, 1, 0, 1,  1, 0, 1, 0, 1, 0, 1];
  gWKey = canvas.width / v('keysPerBoard');
  gHKey = hBoard / 2;
  gKeys = [];
  for (var b = 0; b < v('boards'); ++b) {
    for (var k = 0; k < v('keysPerBoard'); ++k) {
      var x = gWKey * k;
      var y = canvas.height - hBoard * (b + 1) + (white[k % 12] ? gHKey : 0);
      var n = parseInt(v('lowestNote')) + b * v('octavesBetweenBoards') * 12 + k;
      gKeys.push({x: x, y: y, n: n, touches: 0, newTouches: 0});
      var g = white[k % 12] ? 255 : 127;
      rect(context, x, y, x + gWKey, y + gHKey, 0, g, 0);
    }
  }
}

function touchHandle(x, y, down) {
  for (var k = 0; k < gKeys.length; ++k) {
    var dx = x - gKeys[k].x;
    var dy = y - gKeys[k].y;
    if (0 < dx && dx < gWKey && 0 < dy && dy < gHKey) {
      gKeys[k].newTouches += down ? 1 : -1;
      return;
    }
  }
}

function processNewTouches() {
  for (var k = 0; k < gKeys.length; ++k) {
    if (gKeys[k].newTouches != 0) {
      var oldTouches = gKeys[k].touches;
      gKeys[k].touches += gKeys[k].newTouches;
      gKeys[k].newTouches = 0;
      if (oldTouches == 0 && gKeys[k].touches != 0) send(gKeys[k].n, true);
      else if (oldTouches != 0 && gKeys[k].touches == 0) send(gKeys[k].n, false);
    }
  }
  if (gDebug) {
    var canvas = e('canvas');
    var context = canvas.getContext('2d');
    rect(context, 5, 0, 140, canvas.height * 0.75, 40, 0, 0);
    context.fillStyle = 'rgb(255, 0, 0)';
    for (var i = 0; i < gMessages.length; ++i)
      context.fillText(gMessages[i], 10, canvas.height * 0.75 - (gMessages.length - i) * 16);
  }
}

var gTouchHappened = false;
var gTouches = {};

function touchStart(evt) {
  gTouchHappened = true;
  for (var i = 0; i < evt.changedTouches.length; ++i) {
    var touch = evt.changedTouches[i];
    gTouches[touch.identifier] = {x: touch.clientX, y: touch.clientY};
    debugLog(`touchStart ${touch.clientX} ${touch.clientY}`);
    touchHandle(touch.clientX, touch.clientY, true);
  }
  processNewTouches();
}

function touchEnd(evt) {
  gTouchHappened = true;
  for(var i = 0; i < evt.changedTouches.length; ++i){
    var touch = evt.changedTouches[i];
    var oldTouch = gTouches[touch.identifier];
    touchHandle(oldTouch.x, oldTouch.y, false);
    delete gTouches[touch.identifier];
    debugLog(`touchEnd ${touch.clientX} ${touch.clientY}`);
  }
  processNewTouches();
}

function touchMove(evt){
  gTouchHappened = true;
  for(var i = 0; i < evt.changedTouches.length; ++i){
    var touch = evt.changedTouches[i];
    var oldTouch = gTouches[touch.identifier];
    debugLog(`touchMove ${touch.clientX} ${touch.clientY}`);
    touchHandle(oldTouch.x, oldTouch.y, false);
    touchHandle(touch.clientX, touch.clientY, true);
    gTouches[touch.identifier] = {x: touch.clientX, y: touch.clientY};
  }
  processNewTouches();
}

var gMouseDragging = false;
var gMouseXOld;
var gMouseYOld;

function mouseDown(evt) {
  if (gTouchHappened) return;
  debugLog(`mouseDown ${evt.clientX} ${evt.clientY}`);
  gMouseXOld = evt.clientX;
  gMouseYOld = evt.clientY;
  gMouseDragging = true;
  touchHandle(evt.clientX, evt.clientY, true);
  processNewTouches();
}

function mouseUp(evt) {
  if (gTouchHappened) return;
  debugLog(`mouseUp ${evt.clientX} ${evt.clientY}`);
  gMouseDragging = false;
  touchHandle(evt.clientX, evt.clientY, false);
  processNewTouches();
}

function mouseMove(evt) {
  if (gTouchHappened) return;
  debugLog(`mouseMove ${evt.clientX} ${evt.clientY}`);
  if (!gMouseDragging) return;
  touchHandle(gMouseXOld, gMouseYOld, false);
  touchHandle(evt.clientX, evt.clientY, true);
  gMouseXOld = evt.clientX;
  gMouseYOld = evt.clientY;
  processNewTouches();
}

var gKeysDown = {};

function key(evt, down) {
  if (evt.repeat) return;
  if (down) {
    if (gKeysDown[evt.key]) return;
    gKeysDown[evt.key] = true;
  } else {
    gKeysDown[evt.key] = false;
  }
  const note = {
              z :  0,  v :  5, ',': 11,
              s :  1,  g :  6,  l : 12,
              x :  2,  b :  7, '.': 13,
              d :  3,  h :  8, ';': 14,
              c :  4,  n :  9, '/': 15,
                       j : 10,
                       m : 11,

    '1': 10,  w : 12,  t : 17,  o : 24,
     q : 11, '3': 13, '6': 18, '0': 25,
              e : 14,  y : 19,  p : 26,
             '4': 15, '7': 20, '-': 27,
              r : 16,  u : 21, '[': 28,
                      '8': 22,
                       i : 23,
  }[evt.key];
  send(parseInt(v('lowestNote')) + note, down);
}

window.onload = function() {
  const canvas = e('canvas');
  canvas.addEventListener('touchstart' , touchStart);
  canvas.addEventListener('touchend'   , touchEnd);
  canvas.addEventListener('touchcancel', touchEnd);
  canvas.addEventListener('touchmove'  , touchMove);
  canvas.addEventListener('mousedown', mouseDown);
  canvas.addEventListener('mouseup'  , mouseUp);
  canvas.addEventListener('mousemove', mouseMove);
  window.onkeydown = (evt) => key(evt, true);
  window.onkeyup   = (evt) => key(evt, false);
}

  </script>
</head>
<body style='margin: 0' onresize='resize()'>

<div id='divInit'>
  <div>keys per board: <input type='number' id='keysPerBoard' value='13'/></div>
  <div>boards: <input type='number' id='boards' value='1'/></div>
  <div>octaves between boards: <input type='number' id='octavesBetweenBoards' value='1'/></div>
  <div>lowest note: <input type='number' id='lowestNote' value='60'/></div>
  <div>
    <button onclick='connect()'>connect</button>
    debug: <input type='checkbox' id='debug'/>
  </div>
</div>
<div id='divBoard' style='display: none; height: 100%; width: 100%;'>
  <canvas id='canvas' style='height: 100%; width: 100%;'/>
</div>

</body>
